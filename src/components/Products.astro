---
import { existsSync } from 'node:fs';

interface LiveProduct {
  name: string;
  description: string;
  href: string;
  linkLabel: string;
  target: string;
  logo?: string;
  visual?: string;
  featured?: boolean;
}

interface UpcomingProduct {
  name: string;
  description: string;
  status: string;
  logo?: string;
}

interface CommunityProduct {
  name: string;
  description: string;
  href: string;
  linkLabel: string;
  target: string;
  logo?: string;
  points: string[];
}

interface Props {
  liveProducts: LiveProduct[];
  communityProduct: CommunityProduct;
  upcomingProducts: UpcomingProduct[];
}

const { liveProducts, communityProduct, upcomingProducts } = Astro.props as Props;
const basePath = import.meta.env.BASE_URL.replace(/\/$/, '');
const toPublicPath = (path?: string) => (path ? `${basePath}${path}` : undefined);
const hasPublicAsset = (path?: string) => {
  if (!path) return false;
  const normalized = path.replace(/^\//, '');
  return existsSync(new URL(`../../public/${normalized}`, import.meta.url));
};

const featured =
  liveProducts.find((item) => item.featured) ??
  liveProducts[0] ?? {
    name: 'AIプロダクト',
    description: 'プロダクト情報を準備中です。',
    href: '#contact',
    linkLabel: 'お問い合わせ',
    target: '建築実務者',
  };
const standardProducts = liveProducts.filter((item) => item.name !== featured.name);
const featuredLogo = hasPublicAsset(featured.logo) ? toPublicPath(featured.logo) : undefined;
const featuredVisual = hasPublicAsset(featured.visual) ? toPublicPath(featured.visual) : undefined;
---

<section id="products" class="section-space bg-white">
  <div class="site-container">
    <p class="section-eyebrow">AI × 建築</p>
    <h2 class="section-title">AIプロダクト</h2>
    <p class="section-summary">
      建築実務の課題に対して、運用中プロダクトと開発中プロダクトを公開しています。
      AI建築サークルは、ツール提供を含む会員制コミュニティとして別枠で案内します。
    </p>

    <article class="soft-card mt-12 overflow-hidden border-accent-300 bg-surface-50">
      <div class="grid gap-6 p-7 sm:p-8 lg:grid-cols-[1.1fr,0.9fr] lg:items-center">
        <div>
          <p class="text-xs uppercase tracking-[0.14em] text-accent-600">Featured Product</p>
          <h3 class="mt-2 text-4xl font-semibold text-surface-900 sm:text-5xl">{featured.name}</h3>
          {featuredLogo && (
            <img
              src={featuredLogo}
              alt={`${featured.name} ロゴ`}
              class="mt-4 h-10 w-auto max-w-full object-contain"
              loading="lazy"
            />
          )}
          <p class="mt-4 text-base text-surface-700">{featured.description}</p>
        </div>

        <div class="rounded-3xl border border-surface-200 bg-white p-6">
          {featuredVisual && (
            <img
              src={featuredVisual}
              alt={`${featured.name}の画面イメージ`}
              class="mb-5 h-44 w-full rounded-2xl border border-surface-200 object-cover"
              loading="lazy"
            />
          )}
          <p class="text-xs uppercase tracking-[0.14em] text-surface-500">対象ユーザー</p>
          <p class="mt-2 text-sm font-medium text-surface-800">{featured.target}</p>
          <a
            href={featured.href}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-5 inline-flex items-center justify-center rounded-full bg-surface-900 px-5 py-2.5 text-sm font-medium text-white hover:bg-surface-700"
          >
            {featured.linkLabel}
          </a>
        </div>
      </div>
    </article>

    <div class="mt-8 grid gap-5 md:grid-cols-2">
      {standardProducts.map((product) => (
        <article class="soft-card p-6">
          {hasPublicAsset(product.logo) && (
            <img
              src={toPublicPath(product.logo)}
              alt={`${product.name} ロゴ`}
              class="h-10 w-auto max-w-full object-contain"
              loading="lazy"
            />
          )}
          <h3 class="text-2xl font-semibold text-surface-900">{product.name}</h3>
          <p class="mt-3 text-sm text-surface-600">{product.description}</p>
          <p class="mt-4 text-xs text-surface-500">対象: {product.target}</p>
          <a
            href={product.href}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-5 inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-500"
          >
            {product.linkLabel}
          </a>
        </article>
      ))}
    </div>

    <article class="soft-card mt-10 border-accent-300/60 bg-accent-300/10 p-6 sm:p-8">
      <div class="grid gap-6 lg:grid-cols-[0.95fr,1.05fr] lg:items-center">
        <div>
          <p class="text-xs uppercase tracking-[0.14em] text-accent-600">Community with Tools</p>
          <h3 class="mt-2 text-3xl font-semibold text-surface-900 sm:text-4xl">{communityProduct.name}</h3>
          {hasPublicAsset(communityProduct.logo) && (
            <img
              src={toPublicPath(communityProduct.logo)}
              alt={`${communityProduct.name} ロゴ`}
              class="mt-4 h-16 w-auto rounded-xl object-contain"
              loading="lazy"
            />
          )}
          <p class="mt-4 text-sm text-surface-700">{communityProduct.description}</p>
        </div>

        <div class="rounded-2xl border border-surface-200 bg-white p-5">
          <p class="text-xs uppercase tracking-[0.14em] text-surface-500">対象</p>
          <p class="mt-1 text-sm font-medium text-surface-800">{communityProduct.target}</p>
          <ul class="mt-4 space-y-2 text-sm text-surface-700">
            {communityProduct.points.map((point) => (
              <li class="flex items-start gap-2">
                <span class="mt-2 h-1.5 w-1.5 rounded-full bg-accent-500"></span>
                <span>{point}</span>
              </li>
            ))}
          </ul>
          <a
            href={communityProduct.href}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-5 inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-500"
          >
            {communityProduct.linkLabel}
          </a>
        </div>
      </div>
    </article>

    <div class="mt-10 rounded-3xl border border-surface-200 bg-surface-50 p-6 sm:p-8">
      <p class="text-xs uppercase tracking-[0.14em] text-accent-600">Coming Soon</p>
      <div class="mt-5 grid gap-4 md:grid-cols-2">
        {upcomingProducts.map((product) => (
          <article class="rounded-2xl border border-surface-200 bg-white p-5">
            {hasPublicAsset(product.logo) && (
              <img
                src={toPublicPath(product.logo)}
                alt={`${product.name} ロゴ`}
                class="mb-4 h-10 w-auto max-w-full object-contain"
                loading="lazy"
              />
            )}
            <div class="flex items-center justify-between gap-4">
              <h3 class="text-2xl font-semibold text-surface-900">{product.name}</h3>
              <span class="rounded-full border border-accent-300 bg-accent-300/20 px-3 py-1 text-xs font-medium text-accent-600">
                {product.status}
              </span>
            </div>
            <p class="mt-3 text-sm text-surface-600">{product.description}</p>
            {!hasPublicAsset(product.logo) && <p class="mt-2 text-xs text-surface-500">ロゴ整備中</p>}
          </article>
        ))}
      </div>
    </div>
  </div>
</section>
